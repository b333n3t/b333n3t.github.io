<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pixel-Marionette – Intro (b3nn3t fix)</title>
  <style>
    :root{ --bg:#333; --duration:11000; }
    html,body{height:100%;margin:0;background:var(--bg);}
    body{overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    canvas{display:block;width:100vw;height:100vh;image-rendering:pixelated;image-rendering:crisp-edges;background:var(--bg)}
  </style>
</head>
<body>
  <canvas id="stage"></canvas>

  <script>
  const HEAD_IMG_URL = location.origin + "/img/dein-pixel-kopf.webp?v=" + Date.now();
  const RUN_TO_RIGHT = true;
  const CHROMA_TOLERANCE = 40;
  const TRAIL_TEXT = "b3nn3t";
  const TRAIL_SPAWN_MS = 400;
  const HAMMER_MS = 350;
  const SPARK_COUNT = 10;

  const canvas = document.getElementById('stage');
  const ctx = canvas.getContext('2d');

  let W,H,DPR;
  function resize(){
    DPR = Math.max(1, Math.floor(window.devicePixelRatio||1));
    W = canvas.width  = Math.floor(innerWidth * DPR);
    H = canvas.height = Math.floor(innerHeight * DPR);
    canvas.style.width  = innerWidth + 'px';
    canvas.style.height = innerHeight + 'px';
    ctx.imageSmoothingEnabled = false;
  }
  window.addEventListener('resize',resize); resize();

  const lineY   = () => Math.floor(H*2/3);
  const lineEndX= () => Math.floor(W*0.82);
  const PX      = () => Math.max(2, Math.floor(Math.min(W,H)/240));

  const avatar = {
    state:'walk',
    x: RUN_TO_RIGHT ? -40*PX() : W+40*PX(),
    y: lineY() - 3*PX(),
    vx: RUN_TO_RIGHT ? 2.1 : -2.1,
    vy:0, gravity:.35, step:0,
    headScale:22, bodyScale:12,
    hammerUntil: 0
  };

  // --- Funken ---
  const sparks=[];
  function spawnSparks(x,y){
    const p=PX();
    for(let i=0;i<SPARK_COUNT;i++){
      const ang = Math.random()*Math.PI - Math.PI/2;
      const spd = (0.8+Math.random()*0.8)*6*p;
      sparks.push({x,y,vx:Math.cos(ang)*spd,vy:Math.sin(ang)*spd-1*p,life:450+Math.random()*250,born:performance.now(),alpha:1});
    }
  }
  function updateSparks(){
    const now=performance.now(),p=PX();
    for(let i=sparks.length-1;i>=0;i--){
      const s=sparks[i],t=now-s.born;
      if(t>s.life){sparks.splice(i,1);continue;}
      s.vy+=0.02*p;s.x+=s.vx*0.016;s.y+=s.vy*0.016;s.alpha=1-(t/s.life);
    }
  }
  function drawSparks(){
    const p=PX();
    for(const s of sparks){
      ctx.globalAlpha=Math.max(0,Math.min(1,s.alpha));
      ctx.fillStyle='#ffd966';
      ctx.fillRect(Math.round(s.x/p)*p,Math.round(s.y/p)*p,2*p,2*p);
    }
    ctx.globalAlpha=1;
  }

  // --- Kopf laden ---
  function removeGrayBG(image,tolerance=CHROMA_TOLERANCE){
    const off=document.createElement("canvas");
    off.width=image.width;off.height=image.height;
    const octx=off.getContext("2d",{willReadFrequently:true});
    octx.imageSmoothingEnabled=false;
    octx.drawImage(image,0,0);
    const imgData=octx.getImageData(0,0,off.width,off.height);
    const d=imgData.data;const keyR=d[0],keyG=d[1],keyB=d[2];
    for(let i=0;i<d.length;i+=4){
      const dr=Math.abs(d[i]-keyR),dg=Math.abs(d[i+1]-keyG),db=Math.abs(d[i+2]-keyB);
      if(dr<tolerance&&dg<tolerance&&db<tolerance)d[i+3]=0;
    }
    octx.putImageData(imgData,0,0);
    return off;
  }
  let headReady=false;
  let headImg=new Image();headImg.crossOrigin='anonymous';
  headImg.onload=()=>{headImg=removeGrayBG(headImg);headReady=true;};
  headImg.src=HEAD_IMG_URL;

  // --- Linie ---
  function drawLine(){
    ctx.strokeStyle='#fff';
    ctx.lineWidth=2*PX();
    ctx.beginPath();ctx.moveTo(0,lineY());ctx.lineTo(lineEndX(),lineY());ctx.stroke();
  }

  // --- Körper ---
  function rect(px,py,w,h,fill){
    ctx.fillStyle=fill;ctx.fillRect(px,py,w,h);
    ctx.fillStyle='#000';
    ctx.fillRect(px-1,py,w+2,1);
    ctx.fillRect(px-1,py+h-1,w+2,1);
    ctx.fillRect(px-1,py,1,h);
    ctx.fillRect(px+w-1,py,1,h);
  }

  function drawBody(x,y){
    const p=PX(),bodyH=avatar.bodyScale*p,bodyW=Math.round(8*p);
    const legLen=Math.round(9*p),armLen=Math.round(7*p);
    const torsoX=Math.round(x-bodyW/2),torsoY=Math.round(y-bodyH);
    rect(torsoX,torsoY,bodyW,bodyH,'#2b3a56');

    const armTh=3*p,legTh=4*p;
    const hammering=performance.now()<avatar.hammerUntil;
    const armSwing=hammering?Math.sin(Math.PI)*-2*p:Math.sin(avatar.step)*1*p;

    rect(Math.round(x+3*p),torsoY+Math.round(3*p)+Math.round(armSwing),armTh,armLen,'#2b3a56');
    rect(Math.round(x-6*p),torsoY+Math.round(3*p)-Math.round(armSwing),armTh,armLen,'#2b3a56');

    rect(Math.round(x+1*p),y-legLen,legTh,legLen,'#233047');
    rect(Math.round(x-3*p),y-legLen,legTh,legLen,'#233047');

    // Stiefel
    rect(Math.round(x+1*p),Math.round(lineY()-3*p),6*p,3*p,'#7a4f1f');
    rect(Math.round(x-3*p),Math.round(lineY()-3*p),6*p,3*p,'#7a4f1f');

    // Hammer
    if(hammering){
      const hx=Math.round(x+8*p);
      const hy=Math.round(torsoY+6*p);
      ctx.fillStyle='#7a4f1f';ctx.fillRect(hx,hy,1*p,8*p);
      ctx.fillStyle='#c0c0c0';ctx.fillRect(hx-3*p,hy,7*p,2*p);
      ctx.fillStyle='#000';
      ctx.fillRect(hx-3*p-1,hy,1,2*p);
      ctx.fillRect(hx+7*p-1,hy,1,2*p);
      ctx.fillRect(hx-3*p-1,hy-1,7*p+2,1);
      ctx.fillRect(hx-3*p-1,hy+2*p-1,7*p+2,1);
    }
  }

  function drawHead(x,y){
    const p=PX();
    const s=avatar.headScale*p;const w=s,h=s;
    const top=y-avatar.bodyScale*p-s-2*p;
    if(headReady&&headImg&&headImg.width)
      ctx.drawImage(headImg,Math.round(x-w/2),Math.round(top),Math.round(w),Math.round(h));
  }

  // --- Buchstaben (bleiben stehen!) ---
  const letters=[]; let nextSpawnAt=performance.now()+TRAIL_SPAWN_MS; let spawnIndex=0;
  function spawnNextLetter(){
    const p=PX(); const ch=TRAIL_TEXT[spawnIndex];
    const fixedX = W/2 - (TRAIL_TEXT.length*6*p)/2 + spawnIndex*12*p;
    const fixedY = lineY() - avatar.bodyScale*p - 12*p;
    letters.push({ch,x:fixedX,y:fixedY});
    avatar.hammerUntil=performance.now()+HAMMER_MS;
    spawnSparks(fixedX,fixedY);
    spawnIndex++;
  }
  function drawLetters(){
    const p=PX();
    ctx.font=(12*p)+'px monospace'; ctx.textBaseline='middle';
    for(const L of letters){
      ctx.lineWidth=2*p; ctx.strokeStyle='#000';
      ctx.strokeText(L.ch,Math.round(L.x),Math.round(L.y));
      ctx.fillStyle='#f2f2f2'; ctx.fillText(L.ch,Math.round(L.x),Math.round(L.y));
    }
  }

  // --- Loop ---
  function tick(){
    ctx.clearRect(0,0,W,H);
    drawLine();
    const p=PX(),speed=avatar.vx*p,now=performance.now();
    if(spawnIndex<TRAIL_TEXT.length&&now>=nextSpawnAt){
      spawnNextLetter();nextSpawnAt=now+TRAIL_SPAWN_MS;
    }
    updateSparks();drawLetters();drawSparks();

    if(avatar.state==='walk'){
      avatar.x+=speed;avatar.step+=.15;
      avatar.y=lineY()-3*p+Math.round(Math.sin(avatar.step*2)*0.5*p);
      if(avatar.x>=lineEndX()-6*p){avatar.state='fall';avatar.vy=0;}
    }else if(avatar.state==='fall'){
      avatar.vy+=avatar.gravity*p*.6;
      avatar.y+=avatar.vy;
      avatar.x+=speed*.2; // ganze Figur fällt mit
      if(avatar.y>H+40*p){avatar.state='done';}
    }
    drawBody(avatar.x,avatar.y);drawHead(avatar.x,avatar.y);
    requestAnimationFrame(tick);
  }
  tick();
  </script>
</body>
</html>
